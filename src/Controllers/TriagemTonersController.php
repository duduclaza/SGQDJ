<?php

namespace App\Controllers;

use App\Config\Database;
use App\Services\PermissionService;
use PDO;

class TriagemTonersController
{
    private PDO $db;

    public function __construct()
    {
        $this->db = Database::getInstance();
        $this->ensureTablesExist();
    }

    private function ensureTablesExist(): void
    {
        try {
            $this->db->exec("
                CREATE TABLE IF NOT EXISTS triagem_toners (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    toner_id INT NOT NULL,
                    toner_modelo VARCHAR(255) NOT NULL,
                    cliente_id INT NULL,
                    cliente_nome VARCHAR(255) NULL,
                    codigo_requisicao VARCHAR(100) NULL,
                    defeito_id INT NULL,
                    defeito_nome VARCHAR(255) NULL,
                    modo ENUM('peso','percentual') NOT NULL DEFAULT 'peso',
                    peso_retornado DECIMAL(10,2) NULL,
                    percentual_informado DECIMAL(5,2) NULL,
                    gramatura_restante DECIMAL(10,2) NULL,
                    percentual_calculado DECIMAL(5,2) NOT NULL,
                    parecer TEXT NULL,
                    destino ENUM('Descarte','Garantia','Uso Interno','Estoque') NOT NULL,
                    valor_recuperado DECIMAL(10,2) NULL DEFAULT 0.00,
                    observacoes TEXT NULL,
                    created_by INT NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    updated_by INT NULL,
                    updated_at TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP,
                    INDEX idx_toner_id (toner_id),
                    INDEX idx_cliente_id (cliente_id),
                    INDEX idx_defeito_id (defeito_id),
                    INDEX idx_destino (destino),
                    INDEX idx_created_at (created_at),
                    INDEX idx_created_by (created_by)
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
            ");

            // Compatibilidade para bases antigas (antes de cliente_id/cliente_nome)
            $colClienteId = $this->db->query("SHOW COLUMNS FROM triagem_toners LIKE 'cliente_id'")->fetch();
            if (!$colClienteId) {
                $this->db->exec("ALTER TABLE triagem_toners ADD COLUMN cliente_id INT NULL AFTER toner_modelo");
                $this->db->exec("ALTER TABLE triagem_toners ADD INDEX idx_cliente_id (cliente_id)");
            }
            $colClienteNome = $this->db->query("SHOW COLUMNS FROM triagem_toners LIKE 'cliente_nome'")->fetch();
            if (!$colClienteNome) {
                $this->db->exec("ALTER TABLE triagem_toners ADD COLUMN cliente_nome VARCHAR(255) NULL AFTER cliente_id");
            }
            $colCodigoRequisicao = $this->db->query("SHOW COLUMNS FROM triagem_toners LIKE 'codigo_requisicao'")->fetch();
            if (!$colCodigoRequisicao) {
                $this->db->exec("ALTER TABLE triagem_toners ADD COLUMN codigo_requisicao VARCHAR(100) NULL AFTER cliente_nome");
            }
            $colDefeitoId = $this->db->query("SHOW COLUMNS FROM triagem_toners LIKE 'defeito_id'")->fetch();
            if (!$colDefeitoId) {
                $this->db->exec("ALTER TABLE triagem_toners ADD COLUMN defeito_id INT NULL AFTER codigo_requisicao");
                $this->db->exec("ALTER TABLE triagem_toners ADD INDEX idx_defeito_id (defeito_id)");
            }
            $colDefeitoNome = $this->db->query("SHOW COLUMNS FROM triagem_toners LIKE 'defeito_nome'")->fetch();
            if (!$colDefeitoNome) {
                $this->db->exec("ALTER TABLE triagem_toners ADD COLUMN defeito_nome VARCHAR(255) NULL AFTER defeito_id");
            }

            $this->db->exec("
                CREATE TABLE IF NOT EXISTS triagem_toners_parametros (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    percentual_min DECIMAL(5,2) NOT NULL,
                    percentual_max DECIMAL(5,2) NOT NULL,
                    parecer TEXT NOT NULL,
                    ordem INT NOT NULL DEFAULT 0,
                    created_by INT NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    updated_at TIMESTAMP NULL ON UPDATE CURRENT_TIMESTAMP
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
            ");

            // Inserir parâmetros padrão se a tabela estiver vazia
            $count = $this->db->query("SELECT COUNT(*) FROM triagem_toners_parametros")->fetchColumn();
            if ($count == 0) {
                $this->db->exec("
                    INSERT INTO triagem_toners_parametros (percentual_min, percentual_max, parecer, ordem, created_by) VALUES
                    (0,   5,   'Descartar o toner.', 1, 0),
                    (6,   40,  'Teste o toner: se tiver com boa qualidade, use internamente ou em clientes próximos. Se estiver com má qualidade, descarte.', 2, 0),
                    (41,  80,  'Teste o toner: se tiver com boa qualidade, use internamente ou em clientes próximos. Se estiver com má qualidade, solicite garantia para o fornecedor.', 3, 0),
                    (81,  100, 'Teste o toner: se tiver com boa qualidade, envie para a logística como novo. Se estiver com má qualidade, solicite garantia para o fornecedor.', 4, 0)
                ");
            }
        } catch (\Exception $e) {
            error_log('Erro ao criar tabelas de triagem: ' . $e->getMessage());
        }
    }

    // Baixar modelo de importação
    public function downloadTemplate(): void
    {
        try {
            if (!PermissionService::hasPermission($_SESSION['user_id'], 'triagem_toners', 'import')) {
                http_response_code(403);
                echo 'Sem permissão para baixar modelo.';
                return;
            }

            $filename = 'modelo_importacao_triagem_toners_' . date('Ymd') . '.csv';

            header('Content-Type: text/csv; charset=utf-8');
            header('Content-Disposition: attachment; filename="' . $filename . '"');
            header('Pragma: no-cache');
            header('Expires: 0');

            $output = fopen('php://output', 'w');
            fprintf($output, chr(0xEF) . chr(0xBB) . chr(0xBF));

            fputcsv($output, [
                'Código Cliente',
                'Código de Requisição',
                'Defeito (nome simples)',
                'Modelo Toner',
                'Modo (peso/percentual)',
                'Peso Retornado (g)',
                'Percentual (%)',
                'Destino (Descarte/Garantia/Uso Interno/Estoque)',
                'Observações',
            ], ';');

            fputcsv($output, [
                '000123',
                'REQ-2026-0001',
                'Risco no cilindro',
                'HP CF280A',
                'peso',
                '320.5',
                '',
                'Estoque',
                'Lote de teste de importação',
            ], ';');

            fclose($output);
            exit;
        } catch (\Exception $e) {
            http_response_code(500);
            echo 'Erro ao gerar modelo: ' . $e->getMessage();
        }
    }

    // Importar triagens em lote via Excel/CSV
    public function importar(): void
    {
        ob_clean();
        header('Content-Type: application/json');

        if (!PermissionService::hasPermission($_SESSION['user_id'], 'triagem_toners', 'import')) {
            echo json_encode(['success' => false, 'message' => 'Sem permissão para importar.']);
            return;
        }

        try {
            if (!isset($_FILES['arquivo']) || $_FILES['arquivo']['error'] !== UPLOAD_ERR_OK) {
                echo json_encode(['success' => false, 'message' => 'Arquivo não enviado ou com erro.']);
                return;
            }

            $file = $_FILES['arquivo'];
            if ($file['size'] > 10 * 1024 * 1024) {
                echo json_encode(['success' => false, 'message' => 'Arquivo muito grande. Máximo 10MB.']);
                return;
            }

            $extension = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
            if (!in_array($extension, ['csv', 'xls', 'xlsx'])) {
                echo json_encode(['success' => false, 'message' => 'Formato inválido. Use CSV, XLS ou XLSX.']);
                return;
            }

            $rows = $this->readSpreadsheetRows($file['tmp_name'], $extension);
            if (empty($rows) || count($rows) <= 1) {
                echo json_encode(['success' => false, 'message' => 'Planilha vazia ou inválida.']);
                return;
            }

            $header = array_map(static fn($v) => strtolower(trim((string)$v)), $rows[0] ?? []);
            $hasDefeitoColumn = false;
            foreach ($header as $h) {
                if (strpos($h, 'defeito') !== false) {
                    $hasDefeitoColumn = true;
                    break;
                }
            }

            $imported = 0;
            $errors = [];

            foreach ($rows as $index => $row) {
                if ($index === 0) {
                    continue; // cabeçalho
                }

                $line = $index + 1;
                $row = array_map(static fn($v) => trim((string)$v), $row);

                if (empty(array_filter($row))) {
                    continue;
                }

                try {
                    $codigoCliente = $row[0] ?? '';
                    $codigoRequisicao = $row[1] ?? null;

                    // Compatibilidade: layout antigo (sem coluna Defeito) e novo layout (com Defeito)
                    if ($hasDefeitoColumn) {
                        $defeitoNomeRaw = $row[2] ?? '';
                        $modeloToner   = $row[3] ?? '';
                        $modoRaw       = strtolower($row[4] ?? 'peso');
                        $pesoRet       = $row[5] ?? '';
                        $pctRaw        = $row[6] ?? '';
                        $destinoRaw    = $row[7] ?? '';
                        $observacoes   = $row[8] ?? null;
                    } else {
                        $defeitoNomeRaw = '';
                        $modeloToner   = $row[2] ?? '';
                        $modoRaw       = strtolower($row[3] ?? 'peso');
                        $pesoRet       = $row[4] ?? '';
                        $pctRaw        = $row[5] ?? '';
                        $destinoRaw    = $row[6] ?? '';
                        $observacoes   = $row[7] ?? null;
                    }

                    if ($codigoCliente === '' || $modeloToner === '' || $destinoRaw === '') {
                        $errors[] = "Linha {$line}: Código Cliente, Modelo e Destino são obrigatórios.";
                        continue;
                    }

                    $cliente = $this->findClienteByCodigoOrNome($codigoCliente);
                    if (!$cliente) {
                        $errors[] = "Linha {$line}: Cliente '{$codigoCliente}' não encontrado.";
                        continue;
                    }

                    $tonerStmt = $this->db->prepare("SELECT id, modelo, peso_vazio, peso_cheio, gramatura, capacidade_folhas, custo_por_folha FROM toners WHERE LOWER(modelo) = LOWER(?) LIMIT 1");
                    $tonerStmt->execute([$modeloToner]);
                    $toner = $tonerStmt->fetch(PDO::FETCH_ASSOC);
                    if (!$toner) {
                        $errors[] = "Linha {$line}: Toner '{$modeloToner}' não encontrado.";
                        continue;
                    }

                    $modo = in_array($modoRaw, ['percentual', 'pct', '%']) ? 'percentual' : 'peso';

                    $pesoRetNum = ($pesoRet === '') ? null : (float)str_replace(',', '.', $pesoRet);
                    $pctNum     = ($pctRaw === '')  ? null : (float)str_replace(',', '.', $pctRaw);

                    if ($modo === 'peso' && ($pesoRetNum === null || $pesoRetNum < 0)) {
                        $errors[] = "Linha {$line}: Peso Retornado inválido para modo peso.";
                        continue;
                    }
                    if ($modo === 'percentual' && ($pctNum === null || $pctNum < 0)) {
                        $errors[] = "Linha {$line}: Percentual inválido para modo percentual.";
                        continue;
                    }

                    $gramaturaToner = (float)($toner['gramatura'] ?: ((float)$toner['peso_cheio'] - (float)$toner['peso_vazio']));
                    $gramaturaRestante = null;
                    $percentualCalculado = 0;

                    if ($modo === 'peso') {
                        $gramaturaRestante = max(0, $pesoRetNum - (float)$toner['peso_vazio']);
                        $percentualCalculado = $gramaturaToner > 0
                            ? min(100, max(0, round(($gramaturaRestante / $gramaturaToner) * 100, 2)))
                            : 0;
                    } else {
                        $percentualCalculado = min(100, max(0, round((float)$pctNum, 2)));
                        if ($gramaturaToner > 0) {
                            $gramaturaRestante = round(($percentualCalculado / 100) * $gramaturaToner, 2);
                        }
                    }

                    $destino = $this->normalizeDestino($destinoRaw);
                    if ($destino === null) {
                        $errors[] = "Linha {$line}: Destino '{$destinoRaw}' inválido.";
                        continue;
                    }

                    $defeitoId = null;
                    $defeitoNome = null;
                    if ($defeitoNomeRaw !== '') {
                        $defeitoStmt = $this->db->prepare("SELECT id, nome_defeito FROM cadastro_defeitos WHERE LOWER(nome_defeito) = LOWER(?) LIMIT 1");
                        $defeitoStmt->execute([$defeitoNomeRaw]);
                        $defeito = $defeitoStmt->fetch(PDO::FETCH_ASSOC);
                        if (!$defeito) {
                            $errors[] = "Linha {$line}: Defeito '{$defeitoNomeRaw}' não encontrado no cadastro geral.";
                            continue;
                        }
                        $defeitoId = (int)$defeito['id'];
                        $defeitoNome = $defeito['nome_defeito'];
                    }

                    $parecer = $this->getParecer($percentualCalculado);

                    $valorRecuperado = 0.00;
                    if ($destino === 'Estoque') {
                        $capacidade = (float)($toner['capacidade_folhas'] ?? 0);
                        $custoFolha = (float)($toner['custo_por_folha'] ?? 0);
                        if ($capacidade > 0 && $custoFolha > 0) {
                            $valorRecuperado = round((($percentualCalculado / 100) * $capacidade) * $custoFolha, 2);
                        }
                    }

                    $insert = $this->db->prepare("
                        INSERT INTO triagem_toners
                            (toner_id, toner_modelo, cliente_id, cliente_nome, codigo_requisicao,
                             defeito_id, defeito_nome, modo,
                             peso_retornado, percentual_informado, gramatura_restante,
                             percentual_calculado, parecer, destino, valor_recuperado,
                             observacoes, created_by)
                        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                    ");

                    $insert->execute([
                        $toner['id'],
                        $toner['modelo'],
                        $cliente['id'],
                        $cliente['nome'],
                        $codigoRequisicao !== '' ? $codigoRequisicao : null,
                        $defeitoId,
                        $defeitoNome,
                        $modo,
                        $modo === 'peso' ? $pesoRetNum : null,
                        $modo === 'percentual' ? $pctNum : null,
                        $gramaturaRestante,
                        $percentualCalculado,
                        $parecer,
                        $destino,
                        $valorRecuperado,
                        $observacoes,
                        $_SESSION['user_id'],
                    ]);

                    $imported++;
                } catch (\Exception $e) {
                    $errors[] = "Linha {$line}: " . $e->getMessage();
                }
            }

            $success = $imported > 0 || empty($errors);
            $message = "Importação concluída: {$imported} registro(s) importado(s).";
            if ($imported === 0 && !empty($errors)) {
                $message = 'Nenhum registro foi importado. Verifique os erros da planilha.';
            }

            echo json_encode([
                'success' => $success,
                'imported' => $imported,
                'errors' => $errors,
                'message' => $message,
            ]);
        } catch (\Exception $e) {
            echo json_encode(['success' => false, 'message' => 'Erro na importação: ' . $e->getMessage()]);
        }
    }

    // Página principal
    public function index(): void
    {
        if (!PermissionService::hasPermission($_SESSION['user_id'], 'triagem_toners', 'view')) {
            http_response_code(403);
            include __DIR__ . '/../../views/errors/403.php';
            return;
        }

        $userRole = $_SESSION['user_role'] ?? '';
        $isAdmin  = in_array($userRole, ['admin', 'super_admin']);

        try {
            $stmt = $this->db->query("SELECT id, modelo, peso_cheio, peso_vazio, gramatura, capacidade_folhas, custo_por_folha, preco_toner FROM toners WHERE peso_cheio IS NOT NULL AND peso_vazio IS NOT NULL ORDER BY modelo");
            $toners = $stmt->fetchAll(PDO::FETCH_ASSOC);
        } catch (\Exception $e) {
            $toners = [];
        }

        try {
            $stmt = $this->db->query("SELECT id, codigo, nome FROM clientes ORDER BY nome ASC");
            $clientes = $stmt->fetchAll(PDO::FETCH_ASSOC);
        } catch (\Exception $e) {
            $clientes = [];
        }

        try {
            $stmt = $this->db->query("SELECT id, nome_defeito FROM cadastro_defeitos ORDER BY nome_defeito ASC");
            $defeitos = $stmt->fetchAll(PDO::FETCH_ASSOC);
        } catch (\Exception $e) {
            $defeitos = [];
        }

        $parametros = $this->getParametros();

        $title    = 'Triagem de Toners - SGQ OTI DJ';
        $viewFile = __DIR__ . '/../../views/pages/toners/triagem.php';
        include __DIR__ . '/../../views/layouts/main.php';
    }

    // API: Listar registros de triagem
    public function list(): void
    {
        ob_clean();
        header('Content-Type: application/json');

        if (!PermissionService::hasPermission($_SESSION['user_id'], 'triagem_toners', 'view')) {
            echo json_encode(['success' => false, 'message' => 'Sem permissão']);
            return;
        }

        try {
            $page     = max(1, (int)($_GET['page'] ?? 1));
            $perPage  = max(1, min(100, (int)($_GET['per_page'] ?? 15)));
            $offset   = ($page - 1) * $perPage;

            $where  = "WHERE 1=1";
            $params = [];

            if (!empty($_GET['toner_modelo'])) {
                $where .= " AND t.toner_modelo LIKE ?";
                $params[] = '%' . $_GET['toner_modelo'] . '%';
            }
            if (!empty($_GET['destino'])) {
                $where .= " AND t.destino = ?";
                $params[] = $_GET['destino'];
            }
            if (!empty($_GET['data_inicio'])) {
                $where .= " AND DATE(t.created_at) >= ?";
                $params[] = $_GET['data_inicio'];
            }
            if (!empty($_GET['data_fim'])) {
                $where .= " AND DATE(t.created_at) <= ?";
                $params[] = $_GET['data_fim'];
            }

            $countStmt = $this->db->prepare("SELECT COUNT(*) FROM triagem_toners t $where");
            $countStmt->execute($params);
            $total      = (int)$countStmt->fetchColumn();
            $totalPages = (int)ceil($total / $perPage);

            $stmt = $this->db->prepare("
                SELECT t.*,
                       u.name  AS criado_por_nome,
                       uu.name AS atualizado_por_nome
                FROM triagem_toners t
                LEFT JOIN users u  ON u.id  = t.created_by
                LEFT JOIN users uu ON uu.id = t.updated_by
                $where
                ORDER BY t.created_at DESC
                LIMIT $perPage OFFSET $offset
            ");
            $stmt->execute($params);
            $registros = $stmt->fetchAll(PDO::FETCH_ASSOC);

            echo json_encode([
                'success' => true,
                'data'    => $registros,
                'pagination' => [
                    'page'        => $page,
                    'per_page'    => $perPage,
                    'total'       => $total,
                    'total_pages' => $totalPages,
                ],
            ]);
        } catch (\Exception $e) {
            echo json_encode(['success' => false, 'message' => $e->getMessage()]);
        }
    }

    // API: Calcular % e parecer (chamado via AJAX antes de salvar)
    public function calcular(): void
    {
        ob_clean();
        header('Content-Type: application/json');

        try {
            $toner_id   = (int)($_POST['toner_id'] ?? 0);
            $modo       = $_POST['modo'] ?? 'peso';
            $peso_ret   = isset($_POST['peso_retornado'])   ? (float)$_POST['peso_retornado']   : null;
            $pct_inf    = isset($_POST['percentual'])       ? (float)$_POST['percentual']       : null;

            if (!$toner_id) {
                echo json_encode(['success' => false, 'message' => 'Selecione um toner.']);
                return;
            }

            $stmt = $this->db->prepare("SELECT peso_cheio, peso_vazio, gramatura, capacidade_folhas, custo_por_folha, preco_toner FROM toners WHERE id = ?");
            $stmt->execute([$toner_id]);
            $toner = $stmt->fetch(PDO::FETCH_ASSOC);

            if (!$toner) {
                echo json_encode(['success' => false, 'message' => 'Toner não encontrado.']);
                return;
            }

            $gramatura_restante  = null;
            $percentual_calculado = null;

            if ($modo === 'peso') {
                if ($peso_ret === null || $peso_ret < 0) {
                    echo json_encode(['success' => false, 'message' => 'Informe o peso retornado.']);
                    return;
                }
                $gramatura_toner    = (float)($toner['gramatura'] ?: ($toner['peso_cheio'] - $toner['peso_vazio']));
                $gramatura_restante = max(0, $peso_ret - (float)$toner['peso_vazio']);
                $percentual_calculado = $gramatura_toner > 0
                    ? min(100, max(0, round(($gramatura_restante / $gramatura_toner) * 100, 2)))
                    : 0;
            } else {
                if ($pct_inf === null || $pct_inf < 0) {
                    echo json_encode(['success' => false, 'message' => 'Informe o percentual.']);
                    return;
                }
                $percentual_calculado = min(100, max(0, round($pct_inf, 2)));
                $gramatura_toner      = (float)($toner['gramatura'] ?: ($toner['peso_cheio'] - $toner['peso_vazio']));
                if ($gramatura_toner > 0) {
                    $gramatura_restante = round(($percentual_calculado / 100) * $gramatura_toner, 2);
                }
            }

            $parecer = $this->getParecer($percentual_calculado);

            // Calcular valor recuperado se destino for estoque
            $valor_recuperado = 0;
            $capacidade       = (float)($toner['capacidade_folhas'] ?? 0);
            $custo_folha      = (float)($toner['custo_por_folha']   ?? 0);
            if ($capacidade > 0 && $custo_folha > 0 && $percentual_calculado > 0) {
                $folhas_restantes = ($percentual_calculado / 100) * $capacidade;
                $valor_recuperado = round($folhas_restantes * $custo_folha, 2);
            }

            echo json_encode([
                'success'              => true,
                'percentual_calculado' => $percentual_calculado,
                'gramatura_restante'   => $gramatura_restante,
                'parecer'              => $parecer,
                'valor_recuperado'     => $valor_recuperado,
            ]);
        } catch (\Exception $e) {
            echo json_encode(['success' => false, 'message' => $e->getMessage()]);
        }
    }

    // Salvar registro de triagem
    public function store(): void
    {
        ob_clean();
        header('Content-Type: application/json');

        if (!PermissionService::hasPermission($_SESSION['user_id'], 'triagem_toners', 'edit')) {
            echo json_encode(['success' => false, 'message' => 'Sem permissão para registrar triagem.']);
            return;
        }

        try {
            $toner_id    = (int)($_POST['toner_id'] ?? 0);
            $cliente_id  = (int)($_POST['cliente_id'] ?? 0);
            $modo        = $_POST['modo'] ?? 'peso';
            $peso_ret    = isset($_POST['peso_retornado'])  && $_POST['peso_retornado'] !== '' ? (float)$_POST['peso_retornado'] : null;
            $pct_inf     = isset($_POST['percentual'])      && $_POST['percentual'] !== ''     ? (float)$_POST['percentual']     : null;
            $destino     = $_POST['destino']     ?? '';
            $codigoRequisicao = trim($_POST['codigo_requisicao'] ?? '');
            $defeitoId   = isset($_POST['defeito_id']) && $_POST['defeito_id'] !== '' ? (int)$_POST['defeito_id'] : null;
            $observacoes = $_POST['observacoes'] ?? null;

            if (!$toner_id || !$cliente_id || !$destino) {
                echo json_encode(['success' => false, 'message' => 'Toner, cliente e destino são obrigatórios.']);
                return;
            }

            $stmtCliente = $this->db->prepare("SELECT id, nome FROM clientes WHERE id = ?");
            $stmtCliente->execute([$cliente_id]);
            $cliente = $stmtCliente->fetch(PDO::FETCH_ASSOC);
            if (!$cliente) {
                echo json_encode(['success' => false, 'message' => 'Cliente não encontrado.']);
                return;
            }

            $defeitoNome = null;
            if ($defeitoId) {
                $stmtDefeito = $this->db->prepare("SELECT id, nome_defeito FROM cadastro_defeitos WHERE id = ? LIMIT 1");
                $stmtDefeito->execute([$defeitoId]);
                $defeito = $stmtDefeito->fetch(PDO::FETCH_ASSOC);
                if (!$defeito) {
                    echo json_encode(['success' => false, 'message' => 'Defeito selecionado não encontrado.']);
                    return;
                }
                $defeitoNome = $defeito['nome_defeito'];
            }

            $stmt = $this->db->prepare("SELECT modelo, peso_cheio, peso_vazio, gramatura, capacidade_folhas, custo_por_folha FROM toners WHERE id = ?");
            $stmt->execute([$toner_id]);
            $toner = $stmt->fetch(PDO::FETCH_ASSOC);

            if (!$toner) {
                echo json_encode(['success' => false, 'message' => 'Toner não encontrado.']);
                return;
            }

            $gramatura_restante   = null;
            $percentual_calculado = 0;
            $gramatura_toner      = (float)($toner['gramatura'] ?: ($toner['peso_cheio'] - $toner['peso_vazio']));

            if ($modo === 'peso' && $peso_ret !== null) {
                $gramatura_restante   = max(0, $peso_ret - (float)$toner['peso_vazio']);
                $percentual_calculado = $gramatura_toner > 0
                    ? min(100, max(0, round(($gramatura_restante / $gramatura_toner) * 100, 2))) : 0;
            } elseif ($modo === 'percentual' && $pct_inf !== null) {
                $percentual_calculado = min(100, max(0, round($pct_inf, 2)));
                if ($gramatura_toner > 0) {
                    $gramatura_restante = round(($percentual_calculado / 100) * $gramatura_toner, 2);
                }
            } else {
                echo json_encode(['success' => false, 'message' => 'Informe o peso ou o percentual.']);
                return;
            }

            $parecer = $this->getParecer($percentual_calculado);

            $valor_recuperado = 0;
            if ($destino === 'Estoque') {
                $capacidade  = (float)($toner['capacidade_folhas'] ?? 0);
                $custo_folha = (float)($toner['custo_por_folha']   ?? 0);
                if ($capacidade > 0 && $custo_folha > 0) {
                    $folhas_restantes = ($percentual_calculado / 100) * $capacidade;
                    $valor_recuperado = round($folhas_restantes * $custo_folha, 2);
                }
            }

            $insert = $this->db->prepare("
                INSERT INTO triagem_toners
                    (toner_id, toner_modelo, cliente_id, cliente_nome, codigo_requisicao, defeito_id, defeito_nome,
                     modo, peso_retornado, percentual_informado,
                     gramatura_restante, percentual_calculado, parecer, destino,
                     valor_recuperado, observacoes, created_by)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ");
            $insert->execute([
                $toner_id,
                $toner['modelo'],
                $cliente_id,
                $cliente['nome'],
                $codigoRequisicao !== '' ? $codigoRequisicao : null,
                $defeitoId,
                $defeitoNome,
                $modo,
                $peso_ret,
                $pct_inf,
                $gramatura_restante,
                $percentual_calculado,
                $parecer,
                $destino,
                $valor_recuperado,
                $observacoes,
                $_SESSION['user_id'],
            ]);

            echo json_encode(['success' => true, 'message' => 'Triagem registrada com sucesso!', 'id' => $this->db->lastInsertId()]);
        } catch (\Exception $e) {
            echo json_encode(['success' => false, 'message' => $e->getMessage()]);
        }
    }

    // Atualizar registro
    public function update(): void
    {
        ob_clean();
        header('Content-Type: application/json');

        if (!PermissionService::hasPermission($_SESSION['user_id'], 'triagem_toners', 'edit')) {
            echo json_encode(['success' => false, 'message' => 'Sem permissão para editar.']);
            return;
        }

        try {
            $id          = (int)($_POST['id'] ?? 0);
            $toner_id    = (int)($_POST['toner_id'] ?? 0);
            $cliente_id  = (int)($_POST['cliente_id'] ?? 0);
            $modo        = $_POST['modo'] ?? 'peso';
            $peso_ret    = isset($_POST['peso_retornado']) && $_POST['peso_retornado'] !== '' ? (float)$_POST['peso_retornado'] : null;
            $pct_inf     = isset($_POST['percentual'])     && $_POST['percentual'] !== ''     ? (float)$_POST['percentual']     : null;
            $destino     = $_POST['destino']     ?? '';
            $codigoRequisicao = trim($_POST['codigo_requisicao'] ?? '');
            $defeitoId   = isset($_POST['defeito_id']) && $_POST['defeito_id'] !== '' ? (int)$_POST['defeito_id'] : null;
            $observacoes = $_POST['observacoes'] ?? null;

            if (!$id || !$toner_id || !$cliente_id || !$destino) {
                echo json_encode(['success' => false, 'message' => 'Dados incompletos.']);
                return;
            }

            $stmtCliente = $this->db->prepare("SELECT id, nome FROM clientes WHERE id = ?");
            $stmtCliente->execute([$cliente_id]);
            $cliente = $stmtCliente->fetch(PDO::FETCH_ASSOC);
            if (!$cliente) {
                echo json_encode(['success' => false, 'message' => 'Cliente não encontrado.']);
                return;
            }

            $defeitoNome = null;
            if ($defeitoId) {
                $stmtDefeito = $this->db->prepare("SELECT id, nome_defeito FROM cadastro_defeitos WHERE id = ? LIMIT 1");
                $stmtDefeito->execute([$defeitoId]);
                $defeito = $stmtDefeito->fetch(PDO::FETCH_ASSOC);
                if (!$defeito) {
                    echo json_encode(['success' => false, 'message' => 'Defeito selecionado não encontrado.']);
                    return;
                }
                $defeitoNome = $defeito['nome_defeito'];
            }

            $stmt = $this->db->prepare("SELECT modelo, peso_cheio, peso_vazio, gramatura, capacidade_folhas, custo_por_folha FROM toners WHERE id = ?");
            $stmt->execute([$toner_id]);
            $toner = $stmt->fetch(PDO::FETCH_ASSOC);
            if (!$toner) {
                echo json_encode(['success' => false, 'message' => 'Toner não encontrado.']);
                return;
            }

            $gramatura_toner      = (float)($toner['gramatura'] ?: ($toner['peso_cheio'] - $toner['peso_vazio']));
            $gramatura_restante   = null;
            $percentual_calculado = 0;

            if ($modo === 'peso' && $peso_ret !== null) {
                $gramatura_restante   = max(0, $peso_ret - (float)$toner['peso_vazio']);
                $percentual_calculado = $gramatura_toner > 0
                    ? min(100, max(0, round(($gramatura_restante / $gramatura_toner) * 100, 2))) : 0;
            } elseif ($modo === 'percentual' && $pct_inf !== null) {
                $percentual_calculado = min(100, max(0, round($pct_inf, 2)));
                if ($gramatura_toner > 0) {
                    $gramatura_restante = round(($percentual_calculado / 100) * $gramatura_toner, 2);
                }
            }

            $parecer = $this->getParecer($percentual_calculado);

            $valor_recuperado = 0;
            if ($destino === 'Estoque') {
                $capacidade  = (float)($toner['capacidade_folhas'] ?? 0);
                $custo_folha = (float)($toner['custo_por_folha']   ?? 0);
                if ($capacidade > 0 && $custo_folha > 0) {
                    $valor_recuperado = round((($percentual_calculado / 100) * $capacidade) * $custo_folha, 2);
                }
            }

            $upd = $this->db->prepare("
                UPDATE triagem_toners SET
                    toner_id = ?, toner_modelo = ?, cliente_id = ?, cliente_nome = ?, codigo_requisicao = ?,
                    defeito_id = ?, defeito_nome = ?, modo = ?,
                    peso_retornado = ?, percentual_informado = ?,
                    gramatura_restante = ?, percentual_calculado = ?,
                    parecer = ?, destino = ?, valor_recuperado = ?,
                    observacoes = ?, updated_by = ?, updated_at = NOW()
                WHERE id = ?
            ");
            $upd->execute([
                $toner_id, $toner['modelo'], $cliente_id, $cliente['nome'], $codigoRequisicao !== '' ? $codigoRequisicao : null,
                $defeitoId, $defeitoNome, $modo,
                $peso_ret, $pct_inf,
                $gramatura_restante, $percentual_calculado,
                $parecer, $destino, $valor_recuperado,
                $observacoes, $_SESSION['user_id'], $id,
            ]);

            echo json_encode(['success' => true, 'message' => 'Registro atualizado com sucesso!']);
        } catch (\Exception $e) {
            echo json_encode(['success' => false, 'message' => $e->getMessage()]);
        }
    }

    // Duplicar registro
    public function duplicate(): void
    {
        ob_clean();
        header('Content-Type: application/json');

        if (!PermissionService::hasPermission($_SESSION['user_id'], 'triagem_toners', 'edit')) {
            echo json_encode(['success' => false, 'message' => 'Sem permissão para duplicar.']);
            return;
        }

        try {
            $id = (int)($_POST['id'] ?? 0);
            if (!$id) {
                echo json_encode(['success' => false, 'message' => 'ID inválido.']);
                return;
            }

            $stmt = $this->db->prepare("SELECT * FROM triagem_toners WHERE id = ?");
            $stmt->execute([$id]);
            $original = $stmt->fetch(PDO::FETCH_ASSOC);

            if (!$original) {
                echo json_encode(['success' => false, 'message' => 'Registro não encontrado.']);
                return;
            }

            $observacoes = $original['observacoes'] ?? '';
            $prefixoDuplicado = "[Duplicado do registro #{$id}]";
            $observacoes = trim($prefixoDuplicado . ' ' . $observacoes);

            $insert = $this->db->prepare("
                INSERT INTO triagem_toners (
                    toner_id, toner_modelo, cliente_id, cliente_nome, codigo_requisicao,
                    defeito_id, defeito_nome, modo,
                    peso_retornado, percentual_informado, gramatura_restante,
                    percentual_calculado, parecer, destino, valor_recuperado,
                    observacoes, created_by
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ");

            $insert->execute([
                $original['toner_id'],
                $original['toner_modelo'],
                $original['cliente_id'],
                $original['cliente_nome'],
                $original['codigo_requisicao'] ?? null,
                $original['defeito_id'] ?? null,
                $original['defeito_nome'] ?? null,
                $original['modo'],
                $original['peso_retornado'],
                $original['percentual_informado'],
                $original['gramatura_restante'],
                $original['percentual_calculado'],
                $original['parecer'],
                $original['destino'],
                $original['valor_recuperado'],
                $observacoes,
                $_SESSION['user_id'],
            ]);

            echo json_encode([
                'success' => true,
                'message' => 'Registro duplicado com sucesso!',
                'id' => $this->db->lastInsertId(),
            ]);
        } catch (\Exception $e) {
            echo json_encode(['success' => false, 'message' => $e->getMessage()]);
        }
    }

    // Excluir registro
    public function delete(): void
    {
        ob_clean();
        header('Content-Type: application/json');

        if (!PermissionService::hasPermission($_SESSION['user_id'], 'triagem_toners', 'delete')) {
            echo json_encode(['success' => false, 'message' => 'Sem permissão para excluir.']);
            return;
        }

        try {
            $id = (int)($_POST['id'] ?? 0);
            if (!$id) {
                echo json_encode(['success' => false, 'message' => 'ID inválido.']);
                return;
            }
            $this->db->prepare("DELETE FROM triagem_toners WHERE id = ?")->execute([$id]);
            echo json_encode(['success' => true, 'message' => 'Registro excluído com sucesso!']);
        } catch (\Exception $e) {
            echo json_encode(['success' => false, 'message' => $e->getMessage()]);
        }
    }

    // ===== PARÂMETROS =====

    public function getParametrosApi(): void
    {
        ob_clean();
        header('Content-Type: application/json');
        echo json_encode(['success' => true, 'data' => $this->getParametros()]);
    }

    public function saveParametros(): void
    {
        ob_clean();
        header('Content-Type: application/json');

        $userRole = $_SESSION['user_role'] ?? '';
        if (!in_array($userRole, ['admin', 'super_admin'])) {
            echo json_encode(['success' => false, 'message' => 'Apenas admin pode alterar parâmetros.']);
            return;
        }

        try {
            $parametros = json_decode(file_get_contents('php://input'), true);
            if (!is_array($parametros) || empty($parametros)) {
                echo json_encode(['success' => false, 'message' => 'Dados inválidos.']);
                return;
            }

            $this->db->exec("DELETE FROM triagem_toners_parametros");
            $stmt = $this->db->prepare("
                INSERT INTO triagem_toners_parametros (percentual_min, percentual_max, parecer, ordem, created_by)
                VALUES (?, ?, ?, ?, ?)
            ");
            foreach ($parametros as $i => $p) {
                $stmt->execute([
                    (float)$p['percentual_min'],
                    (float)$p['percentual_max'],
                    trim($p['parecer']),
                    $i + 1,
                    $_SESSION['user_id'],
                ]);
            }

            echo json_encode(['success' => true, 'message' => 'Parâmetros salvos com sucesso!']);
        } catch (\Exception $e) {
            echo json_encode(['success' => false, 'message' => $e->getMessage()]);
        }
    }

    // ===== HELPERS =====

    private function getParametros(): array
    {
        try {
            $stmt = $this->db->query("SELECT * FROM triagem_toners_parametros ORDER BY ordem ASC");
            return $stmt->fetchAll(PDO::FETCH_ASSOC);
        } catch (\Exception $e) {
            return [];
        }
    }

    private function getParecer(float $percentual): string
    {
        $parametros = $this->getParametros();
        foreach ($parametros as $p) {
            if ($percentual >= (float)$p['percentual_min'] && $percentual <= (float)$p['percentual_max']) {
                return $p['parecer'];
            }
        }
        return 'Sem parecer definido para este percentual. Verifique os parâmetros de triagem.';
    }

    private function normalizeDestino(string $destino): ?string
    {
        $d = mb_strtolower(trim($destino));
        return match ($d) {
            'descarte' => 'Descarte',
            'garantia' => 'Garantia',
            'uso interno', 'uso_interno' => 'Uso Interno',
            'estoque' => 'Estoque',
            default => null,
        };
    }

    private function findClienteByCodigoOrNome(string $codigoOuNome): ?array
    {
        $valor = trim($codigoOuNome);

        $stmt = $this->db->prepare("SELECT id, nome FROM clientes WHERE codigo = ? LIMIT 1");
        $stmt->execute([$valor]);
        $cliente = $stmt->fetch(PDO::FETCH_ASSOC);
        if ($cliente) {
            return $cliente;
        }

        $stmt = $this->db->prepare("SELECT id, nome FROM clientes WHERE LOWER(nome) = LOWER(?) LIMIT 1");
        $stmt->execute([$valor]);
        $cliente = $stmt->fetch(PDO::FETCH_ASSOC);
        return $cliente ?: null;
    }

    private function readSpreadsheetRows(string $filePath, string $extension): array
    {
        if ($extension === 'csv') {
            $rows = [];
            $handle = fopen($filePath, 'r');
            if ($handle === false) {
                return [];
            }

            $bom = fread($handle, 3);
            if ($bom !== chr(0xEF) . chr(0xBB) . chr(0xBF)) {
                rewind($handle);
            }

            while (($line = fgetcsv($handle, 0, ';')) !== false) {
                if (count($line) === 1 && str_contains((string)$line[0], ',')) {
                    $line = str_getcsv($line[0], ',');
                }
                $rows[] = $line;
            }
            fclose($handle);
            return $rows;
        }

        // XLS/XLSX com PhpSpreadsheet
        $spreadsheet = \PhpOffice\PhpSpreadsheet\IOFactory::load($filePath);
        $sheet = $spreadsheet->getActiveSheet();
        $rows = $sheet->toArray(null, true, true, false);
        $spreadsheet->disconnectWorksheets();
        unset($spreadsheet);

        return $rows;
    }
}
